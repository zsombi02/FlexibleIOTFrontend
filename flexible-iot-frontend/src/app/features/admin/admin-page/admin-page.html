<section class="admin-header">
  <h1>{{ pageTitle }}</h1>
  <p class="subtitle">
    Handle Users, Companies, and Device Assignments
  </p>
</section>

<section class="admin-grid">
  <mat-card class="admin-card">
    <mat-card-title class="card-header">
      <span>Users</span>

      @if (authService.hasRole('Manager') || authService.hasRole('Admin')) {
        <button mat-stroked-button color="primary" (click)="openAddUserDialog()">
          <mat-icon>person_add</mat-icon>
          Add user
        </button>
      }
    </mat-card-title>

    <mat-card-content>
      <table class="admin-table">
        <thead>
        <tr>
          <th>Name/Email</th>
          <th>Type</th>
          <th>Organization</th>
          <th>Role</th>
          @if (!authService.hasRole('Operator')) {
            <th>Actions</th>
          }
        </tr>
        </thead>
        <tbody>
          @for (user of users(); track user.id) {
            <tr>
              <td>{{ user.name }}</td>
              <td>
                <span [class]="'badge badge-' + user.type">{{ user.type }}</span>
              </td>
              <td>{{ user.organizationName || '—' }}</td>
              <td>{{ user.role }}</td>

              @if (!authService.hasRole('Operator')) {
                <td class="actions-cell">
                  <button mat-icon-button (click)="openAssignCompanyDialog(user)" title="Assign/Unassign Company">
                    <mat-icon>business</mat-icon>
                  </button>

                  @if (authService.hasRole('Manager')) {
                    <button mat-icon-button color="warn" (click)="deleteUser(user)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  }
                </td>
              }
            </tr>
          }
        </tbody>
      </table>
    </mat-card-content>
  </mat-card>

  @if (!authService.hasRole('Operator')) {
    <mat-card class="admin-card">
      <mat-card-title class="card-header">
        <span>Organizations</span>

        @if (authService.hasRole('Manager')) {
          <button mat-stroked-button color="primary" (click)="openAddOrgDialog()">
            <mat-icon>domain_add</mat-icon>
            Add organization
          </button>
        }
      </mat-card-title>

      <mat-card-content>
        <table class="admin-table">
          <thead>
          <tr>
            <th>Name</th>
            @if (authService.hasRole('Manager')) {
              <th>Actions</th>
            }
          </tr>
          </thead>
          <tbody>
            @for (org of organizations(); track org.id) {
              <tr>
                <td>{{ org.name }}</td>

                @if (authService.hasRole('Manager')) {
                  <td class="actions-cell">
                    <button mat-icon-button color="warn" (click)="deleteOrg(org)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </mat-card-content>
    </mat-card>
  }

  @if (!authService.hasRole('Operator')) {
    <mat-card class="admin-card admin-card-full">
      <mat-card-title class="card-header">
        <span>Assignments (Devices)</span>
        <!-- Itt nincs "Add", mert az a Devices oldalon van -->
      </mat-card-title>

      <mat-card-content>
        <table class="admin-table">
          <thead>
          <tr>
            <th>Device</th>
            <th>Owner</th>
            <th>Company</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
            @for (dev of assignments(); track dev.id) {
              <tr>
                <td>{{ dev.name }}</td>
                <td>{{ dev.ownerUserName }}</td>
                <td>
                  <!-- Szép badge a cégnek -->
                  @if(dev.company) {
                    <span class="badge-org">{{ dev.company }}</span>
                  } @else {
                    <span style="color: #999; font-style: italic;">— Individual —</span>
                  }
                </td>
                <td class="actions-cell">
                  <button mat-icon-button (click)="openAssignDeviceDialog(dev)" title="Change Company">
                    <mat-icon>business</mat-icon> <!-- Cég ikon a váltáshoz -->
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="4" style="text-align: center; color: #777; padding: 20px;">
                 No available Devices
                </td>
              </tr>
            }
          </tbody>
        </table>
      </mat-card-content>
    </mat-card>
  }
</section>
