<mat-card class="widget-card">
  <div class="card-header">
    <div class="header-title">Telemetry Viewer</div>
    <div class="header-meta" *ngIf="dataCount() > 0">{{ dataCount() }} Data Points</div>

    <div class="header-actions">
      <button mat-icon-button (click)="toggleExpand()"
              [matTooltip]="isExpanded() ? 'Collapse' : 'Expand'"
              class="action-btn">
        <mat-icon>{{ isExpanded() ? 'close_fullscreen' : 'open_in_full' }}</mat-icon>
      </button>

      <button mat-icon-button class="action-btn remove" (click)="onRemove()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="card-body">

    <!-- GRID LAYOUT -->
    <div class="controls-grid">

      <!-- 1. ESZKÖZ -->
      <mat-form-field appearance="outline" class="dense-field">
        <mat-label>Device</mat-label>
        <mat-select [(ngModel)]="config.deviceId" (selectionChange)="onDeviceChange()">
          @for (dev of devices; track dev.id) {
            <mat-option [value]="dev.id">{{ dev.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- 2. TÍPUS -->
      <mat-form-field appearance="outline" class="dense-field">
        <mat-label>Type</mat-label>
        <mat-select [(ngModel)]="config.chartType" (selectionChange)="onConfigChange()">
          @for (type of chartTypes; track type.value) {
            <mat-option [value]="type.value">{{ type.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- 3. IDŐABLAK (PRESET) -->
      <mat-form-field appearance="outline" class="dense-field">
        <mat-label>Time Interval</mat-label>
        <mat-select [(ngModel)]="selectedRangeValue" (selectionChange)="onRangeChange($event.value)">
          @for (range of timeRanges; track range.value) {
            <mat-option [value]="range.value">{{ range.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- 4. KEZDET (Csak ha Custom) -->
      <mat-form-field appearance="outline" class="dense-field">
        <mat-label>Start</mat-label>
        <input matInput type="datetime-local" step="1"
               [disabled]="selectedRangeValue !== 0"
               [ngModel]="dateFromStr" (ngModelChange)="dateFromStr = $event">
      </mat-form-field>

      <!-- 5. VÉGE (Csak ha Custom) -->
      <mat-form-field appearance="outline" class="dense-field">
        <mat-label>End</mat-label>
        <input matInput type="datetime-local" step="1"
               [disabled]="selectedRangeValue !== 0"
               [ngModel]="dateToStr" (ngModelChange)="dateToStr = $event">
      </mat-form-field>

    </div>

    <!-- CHART -->
    <div class="chart-container">
      @if (isLoading()) {
        <div class="placeholder">
          <div class="spinner"></div>
          <span>Loading Data...</span>
        </div>
      } @else if (config.deviceId && chartOption()) {
        <div echarts [options]="chartOption()!" class="echart"></div>
      } @else if (!config.deviceId) {
        <div class="placeholder info">
          <mat-icon>touch_app</mat-icon>
          <span>Select a Device!</span>
        </div>
      } @else {
        <div class="placeholder warning">
          <mat-icon>warning</mat-icon>
          <span>No Data Available in the Interval.</span>
        </div>
      }
    </div>

  </div>
</mat-card>
