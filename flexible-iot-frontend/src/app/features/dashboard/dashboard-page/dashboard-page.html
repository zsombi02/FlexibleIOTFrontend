<div class="dashboard-container">

  <header class="dashboard-header">
    <div>
      <h1>{{ pageTitle }}</h1>
      <div class="status-badge" [class.online]="connectionStatus() === 'Online'">
        {{ connectionStatus() }}
      </div>
    </div>
    <div class="header-stats">
      @for (card of statCards(); track card.id) {
        <div class="mini-stat">
          <span class="val">{{ card.value }}</span>
          <span class="sub">{{ card.title }}</span>
        </div>
      }
    </div>
  </header>

  <div class="dashboard-content">

    <div class="middle-split-container">

      <mat-card class="sim-control-panel">
        <mat-card-header>
        </mat-card-header>

        <mat-card-content>

          <div class="demo-switch-container">
            <mat-slide-toggle
              color="primary"
              [checked]="demoMode()"
              (change)="toggleDemoMode($event.checked)">
              Demo Mode
            </mat-slide-toggle>
          </div>

          <hr class="divider">

          <div class="control-group">
            <span class="label">All Devices:</span>
            <div class="btn-row">
              <button mat-raised-button color="primary"
                      (click)="onStartAllSim()"
                      [disabled]="!demoMode()">
                Start All
              </button>
              <button mat-raised-button color="warn"
                      (click)="onStopAllSim()"
                      [disabled]="!demoMode()">
                Stop All
              </button>
            </div>
          </div>

          <hr class="divider">

          <div class="control-group">
            <span class="label">Selected Device:</span>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Choose a device</mat-label>
              <mat-select [disabled]="!demoMode()"
                          [ngModel]="selectedSimDeviceId()"
                          (ngModelChange)="selectedSimDeviceId.set($event)">
                @for (dev of myDevices(); track dev.id) {
                  <mat-option [value]="dev.id">{{ dev.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="btn-row">
              <button mat-stroked-button color="primary"
                      (click)="onStartDeviceSim()"
                      [disabled]="!demoMode() || !selectedSimDeviceId()">
                Start
              </button>
              <button mat-stroked-button color="warn"
                      (click)="onStopDeviceSim()"
                      [disabled]="!demoMode() || !selectedSimDeviceId()">
                Stop
              </button>
            </div>
          </div>

        </mat-card-content>
      </mat-card>

      <mat-card class="chart-panel">
        <mat-tab-group [selectedIndex]="0" (selectedIndexChange)="onTabChange($event)" animationDuration="0ms">
          @for (device of myDevices(); track device.id) {
            <mat-tab>
              <ng-template mat-tab-label>
                {{ device.name }}
                @if (isDeviceLive(device.id)) {
                  <span class="live-dot" title="Élő adat érkezik"></span>
                }
              </ng-template>
            </mat-tab>
          }
        </mat-tab-group>

        <mat-card-content class="chart-container">
          @let currentOptions = chartOption();
          @if (currentOptions) {
            <div echarts [options]="currentOptions" class="echart"></div>
          } @else {
            <div class="waiting-state">
              <div class="pulse"></div>
              <p>Várakozás adatra: <strong>{{ myDevices()[0]?.name || 'Nincs eszköz' }}</strong>...</p>
            </div>
          }
        </mat-card-content>
      </mat-card>

    </div>

    <mat-card class="feed-panel">
      <mat-card-header>
        <mat-card-title>Live feed</mat-card-title>
      </mat-card-header>
      <mat-card-content class="feed-scroll-area">
        <ul class="feed-list">
          @for (item of liveFeedItems(); track item.id) {
            <li class="feed-item">
              <div class="feed-time">{{ item.time }}</div>
              <div class="feed-content">
                <span class="feed-dev">{{ item.deviceName }}</span>
                <span class="feed-val">{{ item.value }} {{ item.unit }}</span>
              </div>
            </li>
          } @empty {
            <li class="empty-feed">No data to show</li>
          }
        </ul>
      </mat-card-content>
    </mat-card>

  </div>
</div>
